<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <title>MyClassBell</title>
  <link rel="icon" href="MyAppIcon.png" type="image/png" />

  <!-- Google tag (gtag.js) & heartbeat -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-M2QXES4LKK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} // eslint-disable-line
    gtag('js', new Date());
    gtag('config', 'G-M2QXES4LKK');
    setInterval(() => { gtag('event', 'heartbeat', { event_category: 'engagement', event_label: 'page_still_open' }); }, 300000);
  </script>

  <style>
    :root{ --header-bg:#000; --header-fg:#fff; --border:#eceff3; --bar-border:#cfd7e3; --accent:#007bff; color-scheme: only light; }
    *{box-sizing:border-box}
    body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Apple Color Emoji','Segoe UI Emoji'; line-height:1.4; font-size:16px; margin:20px; background:#fff; color:#111}

    /* Sticky header container */
    #sticky-container{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--border)}

    /* Header */
    #header-container{display:grid; grid-template-columns:.3fr 1fr .3fr; justify-items:center; align-items:center; padding:6px 8px; background:var(--header-bg); color:var(--header-fg)}
    #date,#time{font-size:1.5em; font-weight:400}
    #school-name{font-size:1.5em; font-weight:400; padding:5px; text-align:center; width:80%; cursor:pointer}
    #day{font-size:1.1em; font-weight:400}

    /* Table base */
    table{width:100%; border-collapse:collapse; table-layout:fixed; background:#fff}
    th,td{border:1px solid var(--border); padding:8px; text-align:center}
    /* Force gray headers everywhere (single + all views) */
    #singleHeader thead th, #schedule thead th, #multiWrapper table thead th{background:#6B7280 !important; color:#fff !important; font-weight:400}

    /* One-line CURRENT progress strip row */
    .current-row td{ padding:0; background:#fff; }
    .current-strip{ height:40px; background:#f7f9fc; position:relative; overflow:hidden; border:1px solid var(--bar-border); border-radius:8px; box-shadow: inset 0 1px 0 rgba(255,255,255,.5), 0 1px 1px rgba(0,0,0,.04) }
    .current-fill{ position:absolute; left:0; top:0; bottom:0; width:var(--fill,0%); background: linear-gradient(90deg, var(--c1,#e9f1ff), var(--c2,#f7fbff)); background-size:200% 100%; animation: stripWave 8s linear infinite; transition:width .5s ease }
    .current-label{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:400; color:#000; font-size:16px; letter-spacing:.3px; padding:0 8px }

    /* Row visuals */
    #schedule tr.data-row, #multiWrapper table tr.data-row { position: relative; }
    #schedule tr.data-row::before, #multiWrapper table tr.data-row::before { content:none; }
    #schedule tr.data-row::after, #multiWrapper table tr.data-row::after{ content:none; }
    #schedule td, #multiWrapper table td { position:relative; z-index:2; background:transparent; }

    /* Completed (passed) classes smaller */
    tr.completed { opacity:.55; font-size:.85em; }

    /* Lunch highlighting */
    tr.lunch td { background:#FFF6D6 !important; color:#0B6B2B; font-weight:800; }
    tr.lunch{ }
    /* Current period row highlight (neutral blue); lunch keeps its own bg */
    tr.upcoming td { background:#DAECFF !important; }
    tr.lunch.upcoming td { background:#B7E3C4 !important; color:#0B6B2B !important; }
    tr.upcoming td:first-child { box-shadow: inset 4px 0 0 #1b6ef3; }

    /* Levelbar */
    #levelbar{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 6px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:0; z-index:1001; flex-wrap:wrap}
    .lvlbtn{background:#f4f4f4; color:#000; border:1px solid var(--border); border-radius:6px; padding:6px 10px; cursor:pointer}
    .lvlbtn[aria-pressed="true"]{background:var(--accent); color:#fff}

    /* All-view: distinctive card colors */
    #multiWrapper{display:none; gap:12px; margin-top:8px; background:#fff;}
    .card{border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#fff !important}
    .card-header{font-weight:400; padding:8px 10px; text-align:center}
    [data-group="g1"] > .card-header{ background:#2F6ADF; color:#fff; }
    [data-group="g2"] > .card-header{ background:#1F8552; color:#fff; }
    [data-group="g3"] > .card-header{ background:#5A3DBF; color:#fff; }

    /* Settings panel */
    #settings-panel{display:none; position:fixed; top:10%; left:50%; transform:translate(-50%,0); background:#fff; border:1px solid #ddd; padding:20px; z-index:2000; box-shadow:0 2px 10px rgba(0,0,0,.1); max-height:80%; overflow:auto; width:340px}
    #settings-panel input, #settings-panel select{margin:6px 0; width:100%; padding:8px}

    /* Color custom */
    #custom-color-box{display:none; position:fixed; top:10%; left:50%; transform:translate(-50%,0); background:#fff; border:1px solid #ddd; padding:20px; z-index:2000; box-shadow:0 2px 10px rgba(0,0,0,.1); width:300px}
    #custom-color-box input{margin:10px 0; width:100%; padding:5px}

    /* What's new */
    #whats-new{font-family:'Open Sans', sans-serif; font-size:12px; font-style:italic}
    #whats-new h3{font-size:16px; font-style:italic; cursor:pointer}
    #whats-new-content{display:none}
    .toggle-arrow{margin-left:5px}

    .footer{width:100%; border-top:1px solid var(--border); padding:5px 20px; display:flex; align-items:center; gap:12px; font-size:.95rem; flex-wrap:wrap}
    .footer a{text-decoration:none; border-radius:5px; padding:5px 10px; color:#fff}
    .readme-link{background:#1b6ef3}
    .track-link{background:#2e8b57}
    .timer-link{background:#ff9800}
    .share .twitter{background:#000}
    .share .facebook{background:#3B5998}
    .share .linkedin{background:#0A66C2}

    @keyframes stripWave { 0% { background-position:0% 0; } 100% { background-position:200% 0; } }

    /* Ensure light mode even if OS prefers dark */
    @media (prefers-color-scheme: dark){ body, #sticky-container, table, th, td { background:#fff !important; color:#000 !important; } }
    .view-title{font-size:1.1rem; font-weight:400; background:#0B2E6F; color:#fff; text-align:center; padding:8px 10px; border-radius:8px; flex:1 0 100%; margin:8px 0 0 0;}
    #singleHeader{margin-top:4px}
    .campus-note{margin-top:8px; font-style:normal; color:#333; background:transparent; text-align:left; padding:0; border-radius:0; font-weight:400}
    .campus-note a{ color:#0645AD; text-decoration:underline; }
    td.editable{cursor:text}
    td[contenteditable="true"]{outline:2px solid #5bb98a; background:#f6fffa}
    #school-name[contenteditable="true"]{outline:2px dashed #5bb98a; background:rgba(91,185,138,.12)}
  </style>
</head>
<body>
  <div id="sticky-container">
    <div id="header-container" role="banner" aria-label="Header with date, school name, and time">
      <div id="date" aria-live="polite">
        <span id="day"></span>
        <span class="separator" aria-hidden="true"> </span>
        <span id="full-date"></span>
      </div>
      <div id="school-name" tabindex="0" title="Click to change header colors">HSA El Paso</div>
      <div id="time" aria-live="polite"></div>
    </div>

    <!-- Top Level Toggle: L1/L2/L3 + All(Admin) + Cafeteria -->
    <div id="levelbar">
      <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
        <button class="lvlbtn" data-view="g1" aria-pressed="false" title="L1 = 6th & 9th">L1</button>
        <button class="lvlbtn" data-view="g2" aria-pressed="false" title="L2 = 7th & 10th">L2</button>
        <button class="lvlbtn" data-view="g3" aria-pressed="false" title="L3 = 8th, 11th & 12th">L3</button>
        <button class="lvlbtn" data-view="all" aria-pressed="false" title="Show all grade groups side-by-side">All</button>
        <button id="cafBtn" class="lvlbtn" aria-pressed="false" title="Show only lunch times">Enable Cafeteria</button>
      </div>
      <div id="rightControls" style="display:flex; gap:6px; align-items:center; margin-left:auto">
        <button id="hideBreaksBtn" class="lvlbtn" aria-pressed="false" title="Hide transitions that have already passed">Hide Passed Breaks</button>
      </div>
      <div id="viewTitle" class="view-title"></div>
    </div>

    <!-- Single-view table header (hidden in All view) -->
    <table id="singleHeader"><thead><tr><th>Block</th><th>Start</th><th>End</th><th>Remaining</th></tr></thead>
    </table>
  </div>

  <!-- Single body OR multi-wrapper will render here -->
  <table id="schedule" aria-label="Schedule table (single view)"><tbody></tbody></table>
  <div id="multiWrapper"></div>

  <!-- Campus note moved under the table(s) -->
  <div id="campus-note-below" class="campus-note">
    For other campuses: If you want a pre-defined bell schedule with your school name and a special link, email your bell schedule to <a href="mailto:saydin19@gmail.com">saydin19@gmail.com</a>.
  </div>

  <!-- Settings (simplified) -->
  <div id="settings-panel">
    <h3>Settings</h3>
    <input type="text" id="school-name-input" placeholder="Enter school name" />
    <label for="group-select"><strong>Default Grade Group</strong></label>
    <select id="group-select">
      <option value="g1">6th & 9th (L1)</option>
      <option value="g2">7th & 10th (L2)</option>
      <option value="g3">8th, 11th & 12th (L3)</option>
    </select>
    <div style="margin-top:8px">
      <label><strong>Visible Grade Groups</strong></label>
      <div style="display:flex; gap:10px; margin-top:6px">
        <label><input type="checkbox" id="enabled-g1"> L1</label>
        <label><input type="checkbox" id="enabled-g2"> L2</label>
        <label><input type="checkbox" id="enabled-g3"> L3</label>
      </div>
    </div>
    <button onclick="saveSettings()">Save</button>
    <button onclick="closeSettings()">Close</button>
  </div>

  <button id="settings-button" style="position:fixed; bottom:20px; right:20px; padding:10px; background:#007bff; color:#fff; border:none; border-radius:50%; cursor:pointer; font-size:16px" onclick="openSettings()">⚙</button>

  <!-- What's New -->
  <div id="whats-new" style="margin-top:14px">
    <h3 onclick="toggleWhatsNew()">What's New <span class="toggle-arrow">&#9660;</span></h3>
    <div id="whats-new-content">
      <ul>
        <li>Added a thin CURRENT progress strip under each table header (color by block type). (2025‑08‑13)</li>
        <li>Class=group color, Transition=red, Lunch=dark green. (2025‑08‑13)</li>
      </ul>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <a class="readme-link" href="readme.html" target="_blank">ReadMe</a>
    <a class="track-link" href="track.html" target="_blank">Hallway Track</a>
    <a class="timer-link" href="timer.html" target="_blank">Timer</a>
    <span class="share">Share: 
      <a class="twitter" href="https://twitter.com/intent/tweet?text=Explore%20this%20incredible%20free%20Bell%20Schedule%20Tool%20designed%20exclusively%20for%20educators!&url=https://classbellschedule.com" target="_blank">Twitter</a>
      <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://classbellschedule.com" target="_blank">Facebook</a>
      <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://classbellschedule.com&title=Explore%20this%20incredible%20free%20Bell%20Schedule%20Tool%20designed%20exclusively%20for%20educators!" target="_blank">LinkedIn</a>
    </span>
  </div>

  <!-- Color Custom Popup -->
  <div id="custom-color-box">
    <h3>Color Custom</h3>
    <label for="bg-color">Header Background</label>
    <input type="color" id="bg-color" value="#000000">
    <label for="text-color">Header Text</label>
    <input type="color" id="text-color" value="#ffffff">
    <button onclick="saveColorCustom()">Save</button>
    <button onclick="closeColorCustom()">Close</button>
  </div>

  <script>
    /* ---------- Utilities ---------- */
    const OV_KEY = 'mb_overrides_v1';
    function timeToHHMM(d){ const h=d.getHours(); const m=d.getMinutes(); return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }
    function parseInputTime(str){ if(!str) return null; const s=str.trim().toUpperCase(); const m=s.match(/^(\d{1,2}):(\d{2})(?:\s*(AM|PM))?$/i); if(!m) return null; let h=parseInt(m[1],10); const mi=parseInt(m[2],10); const ap=m[3]; if(mi>59||h>23) return null; if(ap==='AM' && h===12) h=0; if(ap==='PM' && h<12) h+=12; return {h, m:mi}; }
    function loadOverrides(){ try{ return JSON.parse(localStorage.getItem(OV_KEY)||'{}'); }catch(_){ return {}; } }
    function saveOverrides(obj){ localStorage.setItem(OV_KEY, JSON.stringify(obj)); }
    function saveOverride(dayKey, group, idx, patch){ const o=loadOverrides(); if(!o[dayKey]) o[dayKey]={}; if(!o[dayKey][group]) o[dayKey][group]={}; const cur=o[dayKey][group][idx]||{}; o[dayKey][group][idx] = {...cur, ...patch}; saveOverrides(o); }
    function getDayKey(){ return isFriday() ? 'FRI' : 'MT'; }
    function applyOverrides(full, group, dayKey){ const o=loadOverrides(); const map=(o[dayKey]&&o[dayKey][group])||{}; Object.keys(map).forEach(k=>{ const i=parseInt(k,10); if(Number.isNaN(i) || !full[i]) return; const p=map[k]; if(p.label) full[i].label=p.label; if(p.start){ const [h,mm]=p.start.split(':').map(Number); full[i].start=fmt(h,mm);} if(p.end){ const [h2,m2]=p.end.split(':').map(Number); full[i].end=fmt(h2,m2);} }); return full; }
    function fmt(h,m){ const d=new Date(); d.setHours(h,m,0,0); return d; }
    function parseTime(range){ const [H,M]=range.split(':').map(x=>parseInt(x,10)); return [H,M]; }
    function makeBlock(label, startHM, endHM){ const [sh,sm]=parseTime(startHM); const [eh,em]=parseTime(endHM); return { label, start: fmt(sh,sm), end: fmt(eh,em) }; }

    /* ---------- Canonical Schedules (Mon–Thu, Friday) ---------- */
    function scheduleMT(group){
      const S=[];
      S.push(makeBlock('Breakfast','07:15','07:40'));
      S.push(makeBlock('Transition','07:40','07:45'));
      S.push(makeBlock('1st Period','07:45','08:42'));
      S.push(makeBlock('Transition','08:42','08:46'));
      S.push(makeBlock('2nd Period','08:46','09:43'));
      S.push(makeBlock('Transition','09:43','09:47'));
      S.push(makeBlock('3rd Period','09:47','10:44'));
      S.push(makeBlock('Transition','10:44','10:48'));

      if(group==='g1'){
        S.push(makeBlock('L1 Lunch','10:48','11:23'));
        S.push(makeBlock('Transition','11:23','11:27'));
        S.push(makeBlock('5th Period','11:27','12:24'));
        S.push(makeBlock('Transition','12:24','12:28'));
        S.push(makeBlock('6th Period','12:28','13:25'));
        S.push(makeBlock('Transition','13:25','13:29'));
      } else if(group==='g2'){
        S.push(makeBlock('4th Period','10:48','11:45'));
        S.push(makeBlock('Transition','11:45','11:49'));
        S.push(makeBlock('L2 Lunch','11:49','12:24'));
        S.push(makeBlock('Transition','12:24','12:28'));
        S.push(makeBlock('6th Period','12:28','13:25'));
        S.push(makeBlock('Transition','13:25','13:29'));
      } else {
        S.push(makeBlock('4th Period','10:48','11:45'));
        S.push(makeBlock('Transition','11:45','11:49'));
        S.push(makeBlock('5th Period','11:49','12:46'));
        S.push(makeBlock('Transition','12:46','12:50'));
        S.push(makeBlock('L3 Lunch','12:50','13:25'));
        S.push(makeBlock('Transition','13:25','13:29'));
      }

      S.push(makeBlock('7th Period','13:29','14:26'));
      S.push(makeBlock('Transition','14:26','14:30'));
      S.push(makeBlock('8th Period','14:30','15:27'));
      return S;
    }

    function scheduleFri(){
      const S=[];
      S.push(makeBlock('Breakfast','07:15','07:40'));
      S.push(makeBlock('Transition','07:40','07:45'));
      S.push(makeBlock('1st Period','07:45','08:22'));
      S.push(makeBlock('Transition','08:22','08:26'));
      S.push(makeBlock('2nd Period','08:26','09:03'));
      S.push(makeBlock('Transition','09:03','09:07'));
      S.push(makeBlock('3rd Period','09:07','09:44'));
      S.push(makeBlock('Transition','09:44','09:48'));
      S.push(makeBlock('4th Period','09:48','10:25'));
      S.push(makeBlock('Transition','10:25','10:29'));
      // Lunch waves
      S.push(makeBlock('L1 Lunch','10:29','11:06'));
      S.push(makeBlock('Transition','11:06','11:10'));
      S.push(makeBlock('L2 Lunch','11:10','11:47'));
      S.push(makeBlock('Transition','11:47','11:51'));
      S.push(makeBlock('L3 Lunch','11:51','12:28'));
      S.push(makeBlock('Transition','12:28','12:32'));
      S.push(makeBlock('8th Period','12:32','13:09'));
      return S;
    }

    /* ---------- App State ---------- */
    let currentGroup = localStorage.getItem('gradeGroup') || 'g1';
    let selectedView = localStorage.getItem('selectedView') || currentGroup; // 'g1'|'g2'|'g3'|'all'
    let cafOnly = (localStorage.getItem('cafOnly') === '1');
    let hidePastBreaks = (localStorage.getItem('hidePastBreaks') === '1');
    let isEditing = false;

    const GROUP_TITLES = { g1:'6th Grade & Freshman', g2:'7th Grade & Sophomore', g3:'8th Grade, Junior & Senior' };
    function getEnabledGroups(){
      let obj; try{ obj = JSON.parse(localStorage.getItem('enabledGroups')||'{}'); }catch(_){ obj = {}; }
      const defaults = {g1:true,g2:true,g3:true}; obj = { ...defaults, ...obj };
      const list = Object.keys(defaults).filter(k => !!obj[k]);
      return list.length ? list : ['g1'];
    }
    function setEnabledGroups(obj){ localStorage.setItem('enabledGroups', JSON.stringify(obj)); }
    function isGroupEnabled(id){ return getEnabledGroups().includes(id); }

    function isFriday(){ return new Date().getDay() === 5; }
    function getTodaySchedule(group){ return isFriday() ? scheduleFri() : scheduleMT(group); }

    /* ---------- Cafeteria mode helpers ---------- */
    function getLunchWindowsForToday(groups){
      const gs = Array.isArray(groups) ? groups : getEnabledGroups();
      const wins=[]; const dayKey=getDayKey();
      gs.forEach(g=>{
        let sched = getTodaySchedule(g); sched = applyOverrides(sched, g, dayKey);
        sched.forEach(b=>{ if(/Lunch/i.test(b.label)) wins.push({start:b.start, end:b.end, group:g, label:b.label}); });
      });
      return wins;
    }
    function overlapsLunch(block, windows){ return windows.some(w=> block.start < w.end && block.end > w.start ); }
    function filterByLunchWindows(blocks, windows){ return blocks.filter(b=> !/^Transition$/i.test(b.label) && overlapsLunch(b, windows)); }
    function applyHidePastBreaks(blocks, nowVal){ const now = nowVal || new Date(); return hidePastBreaks ? blocks.filter(b=> !( /^Transition$/i.test(b.label) && b.end < now)) : blocks; }

    /* ---------- Header strip palette ---------- */
    function groupColor(group){ return group==='g1' ? '#1b6ef3' : (group==='g2' ? '#2e8b57' : '#6f42c1'); }
    function getStripPalette(group,label){
      // Slightly darker palettes for better contrast under black text
      if(/Transition/i.test(label)) return ['#ff2d2d','#ff6b6b'];
      if(/Lunch/i.test(label)) return ['#b9e4c3','#d6f2db'];
      if(group==='g1') return ['#bcd4ff','#d5e6ff'];
      if(group==='g2') return ['#cdeed8','#e2f6e8'];
      return ['#cec3ff','#e2d9ff'];
    }

    /* ---------- Rendering helpers ---------- */
    function parseHM(dt){ return dt.toLocaleTimeString('en-US',{hour:'2-digit', minute:'2-digit'}).replace(/^0/,''); }
    function findCurrent(full){
      const now = new Date();
      for(let i=0;i<full.length;i++){
        const b=full[i];
        if(now>=b.start && now<b.end) return { idx:i, b };
      }
      return null;
    }
    function buildCurrentRow(full, group, colCount){
      const row=document.createElement('tr'); row.className='current-row';
      const td=document.createElement('td'); td.colSpan=colCount;
      const strip=document.createElement('div'); strip.className='current-strip';
      const fill=document.createElement('div'); fill.className='current-fill';
      const label=document.createElement('div'); label.className='current-label';
      const now=new Date();
      const cur=findCurrent(full);
      if(cur){
        const total=cur.b.end - cur.b.start; const elapsed=now - cur.b.start; const pct=Math.max(0, Math.min(1, elapsed/total))*100;
        const rem = cur.b.end - now; const m=Math.floor(rem/60000); const s=Math.floor((rem%60000)/1000); const showSec = rem <= 180000;
        const rText = showSec ? `${m}:${s.toString().padStart(2,'0')}` : `${m} min`;
        fill.style.setProperty('--fill', pct+'%');
        const pal = getStripPalette(group, cur.b.label);
        fill.style.setProperty('--c1', pal[0]);
        fill.style.setProperty('--c2', pal[1]);
        label.textContent = `${cur.b.label} — ${rText} left`;
      } else {
        const next = full.find(b=> now < b.start);
        fill.style.setProperty('--fill','0%');
        const pal = getStripPalette(group, '');
        fill.style.setProperty('--c1', pal[0]);
        fill.style.setProperty('--c2', pal[1]);
        label.textContent = next ? `Next: ${next.label} at ${parseHM(next.start)}` : 'Schedule complete';
      }
      strip.appendChild(fill); strip.appendChild(label); td.appendChild(strip); row.appendChild(td); return row;
    }

    function renderRows(blocks, tbody, full, groupId){
      const now=new Date();
      blocks.forEach(b=>{
        const isLunch = /Lunch/i.test(b.label);
        const isOngoing = now>=b.start && now<b.end;
        const isCompleted = now>=b.end;
        const remaining = Math.max(0, b.end - now);
        const remainingSec = Math.floor(remaining/1000);
        const rMin = Math.floor(remainingSec/60);
        const rSec = remainingSec % 60;
        const showSec = remaining <= 180000;
        const remainingText = isOngoing ? (showSec ? `${rMin} min ${rSec.toString().padStart(2,'0')} sec` : `${rMin} min`) : (isCompleted ? 'Completed' : 'Upcoming');
        const tr=document.createElement('tr');
        tr.classList.add('data-row');
        tr.dataset.index = String(full.indexOf(b));
        tr.dataset.group = groupId || '';
        if(isLunch) tr.classList.add('lunch');
        if(isOngoing) tr.classList.add('upcoming');
        if(isCompleted) tr.classList.add('completed');
        tr.innerHTML = `
          <td class="editable" title="Double-click to edit block name">${b.label}</td>
          <td class="editable" title="Double-click to edit start time">${parseHM(b.start)}</td>
          <td class="editable" title="Double-click to edit end time">${parseHM(b.end)}</td>
          <td>${remainingText}</td>`;
        tbody.appendChild(tr);
      });
    }

    function updateSchedule(){
      if(isEditing) return; // pause live re-render while inline editing is active
      const singleHeader = document.getElementById('singleHeader');
      const table = document.getElementById('schedule');
      const multi = document.getElementById('multiWrapper');
      const vt = document.getElementById('viewTitle');

      // Enabled groups and view safety
      const enabled = getEnabledGroups();
      if(['g1','g2','g3'].includes(selectedView) && !enabled.includes(selectedView)){
        selectedView = enabled[0] || 'all'; localStorage.setItem('selectedView', selectedView);
      }
      if(['g1','g2','g3'].includes(currentGroup) && !enabled.includes(currentGroup)){
        currentGroup = enabled[0] || 'g1'; localStorage.setItem('gradeGroup', currentGroup);
      }

      // Dynamic page header per view
      if(selectedView==='g1'){ vt.textContent=GROUP_TITLES.g1 + ' Bell Schedule'; vt.style.display='block'; }
      else if(selectedView==='g2'){ vt.textContent=GROUP_TITLES.g2 + ' Bell Schedule'; vt.style.display='block'; }
      else if(selectedView==='g3'){ vt.textContent=GROUP_TITLES.g3 + ' Bell Schedule'; vt.style.display='block'; }
      else { vt.textContent=''; vt.style.display='none'; }

      // Level button states & visibility
      document.querySelectorAll('.lvlbtn[data-view]').forEach(btn=>{
        const id = btn.getAttribute('data-view');
        if(['g1','g2','g3'].includes(id)){
          btn.style.display = enabled.includes(id) ? '' : 'none';
          btn.setAttribute('aria-pressed', id===selectedView);
        } else if(id==='all'){
          btn.style.display = enabled.length>=1 ? '' : 'none';
          btn.setAttribute('aria-pressed', selectedView==='all');
        }
      });
      // Cafeteria toggle state
      const cafBtn = document.getElementById('cafBtn');
      cafBtn.setAttribute('aria-pressed', cafOnly);
      cafBtn.textContent = cafOnly ? 'Disable Cafeteria' : 'Enable Cafeteria';
      const hbBtn = document.getElementById('hideBreaksBtn');
      hbBtn.setAttribute('aria-pressed', hidePastBreaks);
      hbBtn.textContent = hidePastBreaks ? 'Show Passed Breaks' : 'Hide Passed Breaks';

      const lunchWindows = cafOnly ? getLunchWindowsForToday(enabled) : null;
      const filterBlocks = (arr)=> cafOnly ? filterByLunchWindows(arr, lunchWindows) : arr;

      if(selectedView==='all'){
        singleHeader.style.display='none';
        table.style.display='none';
        multi.style.display='grid';
        multi.style.gridTemplateColumns='repeat(3, minmax(260px, 1fr))';
        multi.innerHTML='';
        const groups = getEnabledGroups().map(id=>({id, title: GROUP_TITLES[id]}));
        groups.forEach(g=>{
          const card=document.createElement('div'); card.className='card'; card.setAttribute('data-group', g.id);
          const hdr=document.createElement('div'); hdr.className='card-header'; hdr.textContent=g.title;
          const tbl=document.createElement('table');
          tbl.innerHTML = `<thead><tr><th>Block</th><th>Start</th><th>End</th><th>Remaining</th></tr></thead>`;
          const tb=document.createElement('tbody');
          let full = getTodaySchedule(g.id); full = applyOverrides(full, g.id, getDayKey());
          // Insert current strip row first
          tb.appendChild(buildCurrentRow(full, g.id, 4));
          const visible = applyHidePastBreaks(filterBlocks(full));
          renderRows(visible, tb, full, g.id);
          tbl.appendChild(tb); card.appendChild(hdr); card.appendChild(tbl); multi.appendChild(card);
        });
      } else {
        singleHeader.style.display='table';
        table.style.display='table';
        multi.style.display='none';
        const tbody=table.querySelector('tbody');
        tbody.innerHTML='';
        let full = getTodaySchedule(selectedView); full = applyOverrides(full, selectedView, getDayKey());
        // Insert current strip row first
        tbody.appendChild(buildCurrentRow(full, selectedView, 4));
        const visible = applyHidePastBreaks(filterBlocks(full));
        renderRows(visible, tbody, full, selectedView);
      }
    }

    // Interactions
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.lvlbtn');
      if(!btn) return;
      if(btn.id==='cafBtn'){
        cafOnly = !cafOnly; localStorage.setItem('cafOnly', cafOnly ? '1' : '0'); updateSchedule(); return;
      }
      if(btn.id==='hideBreaksBtn'){
        hidePastBreaks = !hidePastBreaks; localStorage.setItem('hidePastBreaks', hidePastBreaks ? '1' : '0'); updateSchedule(); return;
      }
      if(btn.dataset.view){
        const id = btn.dataset.view;
        if(['g1','g2','g3'].includes(id) && !isGroupEnabled(id)) return; // ignore disabled group buttons
        selectedView = id; localStorage.setItem('selectedView', selectedView);
        if(selectedView!=='all' && ['g1','g2','g3'].includes(selectedView)){
          currentGroup = selectedView; localStorage.setItem('gradeGroup', currentGroup);
        }
        updateSchedule();
      }
    });

    // Double-click to edit school name, block label, and times (inline, no prompts)
    function selectAll(el){ const r=document.createRange(); r.selectNodeContents(el); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); }
    function commitCellEdit(td){
      const tr = td.closest('tr'); if(!tr) return;
      const idx = parseInt(tr.dataset.index,10); if(Number.isNaN(idx)) return;
      const groupId = tr.dataset.group || (selectedView==='all' ? 'g1' : selectedView);
      const dayKey = getDayKey();
      let full = applyOverrides(getTodaySchedule(groupId), groupId, dayKey);
      const blk = full[idx]; if(!blk) return;
      const col = td.cellIndex;
      const raw = td.textContent.trim();
      if(col===0){ // label
        if(raw){ saveOverride(dayKey, groupId, idx, {label:raw}); }
      } else if(col===1 || col===2){
        const t = parseInputTime(raw);
        if(!t){ alert('Use H:MM or H:MM AM/PM'); td.textContent = col===1?parseHM(blk.start):parseHM(blk.end); return; }
        const newD = fmt(t.h, t.m);
        if(col===1 && newD>=blk.end){ alert('Start must be before end.'); td.textContent=parseHM(blk.start); return; }
        if(col===2 && newD<=blk.start){ alert('End must be after start.'); td.textContent=parseHM(blk.end); return; }
        const patch={}; patch[col===1?'start':'end']=timeToHHMM(newD);
        saveOverride(dayKey, groupId, idx, patch);
      }
      isEditing=false; td.removeAttribute('contenteditable'); updateSchedule();
    }

    document.addEventListener('dblclick', (e)=>{
      // School name inline edit
      if(e.target.closest('#school-name')){
        const sn=document.getElementById('school-name');
        isEditing=true; sn.setAttribute('contenteditable','true'); sn.focus(); selectAll(sn);
        const onBlur=()=>{ const val=sn.textContent.trim(); if(val){ localStorage.setItem('schoolName', val); } sn.removeAttribute('contenteditable'); isEditing=false; sn.removeEventListener('blur', onBlur); };
        sn.addEventListener('blur', onBlur, {once:true});
        return;
      }
      const td = e.target.closest('td.editable'); if(!td) return; const tr=td.closest('tr'); if(!tr || !tr.classList.contains('data-row')) return;
      isEditing=true; td.setAttribute('contenteditable','true'); td.focus(); selectAll(td);
    });

    // Commit edits on Enter/Escape/blur
    document.addEventListener('keydown', (e)=>{
      const ed = e.target.closest('td[contenteditable="true"], #school-name[contenteditable="true"]');
      if(!ed) return;
      if(e.key==='Enter'){ e.preventDefault(); if(ed.id==='school-name'){ ed.blur(); } else { commitCellEdit(ed); } }
      if(e.key==='Escape'){ e.preventDefault(); isEditing=false; ed.removeAttribute('contenteditable'); updateSchedule(); }
    });
    document.addEventListener('blur', (e)=>{
      const td = e.target.closest('td[contenteditable="true"]');
      if(!td) return; commitCellEdit(td);
    }, true);

    /* ---------- Date/Time in header ---------- */
    function displayDateTime(){
      const now=new Date();
      const dayEl=document.getElementById('day');
      const dateEl=document.getElementById('full-date');
      const timeEl=document.getElementById('time');
      if(dayEl&&dateEl&&timeEl){
        dayEl.textContent = now.toLocaleDateString('en-US',{weekday:'long'});
        dateEl.textContent = now.toLocaleDateString('en-US',{year:'numeric', month:'long', day:'numeric'});
        timeEl.textContent = now.toLocaleTimeString('en-US',{hour:'numeric', minute:'numeric', second:'numeric'});
      }
    }

    /* ---------- Settings ---------- */
    function openSettings(){
      document.getElementById('school-name-input').value = localStorage.getItem('schoolName') || '';
      document.getElementById('group-select').value = currentGroup;
      const enabled = getEnabledGroups();
      document.getElementById('enabled-g1').checked = enabled.includes('g1');
      document.getElementById('enabled-g2').checked = enabled.includes('g2');
      document.getElementById('enabled-g3').checked = enabled.includes('g3');
      document.getElementById('settings-panel').style.display='block';
    }
    function closeSettings(){ document.getElementById('settings-panel').style.display='none'; }
    function saveSettings(){
      const name=document.getElementById('school-name-input').value.trim();
      if(name){ localStorage.setItem('schoolName', name); document.getElementById('school-name').textContent = name; }
      // default group
      currentGroup = document.getElementById('group-select').value; localStorage.setItem('gradeGroup', currentGroup);
      // enabled groups
      const eg={ g1: !!document.getElementById('enabled-g1').checked, g2: !!document.getElementById('enabled-g2').checked, g3: !!document.getElementById('enabled-g3').checked };
      if(!eg.g1 && !eg.g2 && !eg.g3){ eg.g1=true; } // ensure at least one
      setEnabledGroups(eg);
      // fix selected view if disabled
      const enabledList = getEnabledGroups();
      if(selectedView!=='all' && !enabledList.includes(selectedView)){
        selectedView = enabledList[0] || 'all'; localStorage.setItem('selectedView', selectedView);
      }
      if(currentGroup && !enabledList.includes(currentGroup)){
        currentGroup = enabledList[0] || 'g1'; localStorage.setItem('gradeGroup', currentGroup);
      }
      closeSettings(); updateSchedule();
    }

    /* ---------- Color Custom ---------- */
    function openColorCustom(){ document.getElementById('custom-color-box').style.display='block'; }
    function closeColorCustom(){ document.getElementById('custom-color-box').style.display='none'; }
    function saveColorCustom(){
      const bg=document.getElementById('bg-color').value; const fg=document.getElementById('text-color').value;
      const header=document.getElementById('header-container');
      header.style.backgroundColor = bg; document.getElementById('school-name').style.color = fg; document.getElementById('date').style.color = fg; document.getElementById('time').style.color = fg;
      localStorage.setItem('headerBgColor', bg); localStorage.setItem('textColor', fg);
      closeColorCustom();
    }
    document.getElementById('school-name').addEventListener('click', openColorCustom);
    function loadColorCustom(){
      const bg=localStorage.getItem('headerBgColor')||'#000000';
      const fg=localStorage.getItem('textColor')||'#ffffff';
      const header=document.getElementById('header-container');
      header.style.backgroundColor = bg; document.getElementById('school-name').style.color = fg; document.getElementById('date').style.color = fg; document.getElementById('time').style.color = fg;
      document.getElementById('bg-color').value = bg; document.getElementById('text-color').value = fg;
    }

    /* ---------- What's New toggle ---------- */
    function toggleWhatsNew(){ const content=document.getElementById('whats-new-content'); const arrow=document.querySelector('.toggle-arrow'); if(content.style.display==='none'){ content.style.display='block'; arrow.innerHTML='&#9650;'; } else { content.style.display='none'; arrow.innerHTML='&#9660;'; } }

    /* ---------- Wake Lock ---------- */
    let wakeLock=null; async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){ console.warn('WakeLock failed', e); } }
    document.addEventListener('visibilitychange', async()=>{ if(wakeLock!==null && document.visibilityState==='visible'){ await requestWakeLock(); } });

    /* ---------- What's New helper (FIXED STRUCTURE) ---------- */
    function appendWhatsNew(){
      const ul=document.querySelector('#whats-new-content ul'); if(!ul) return;
      const now=new Date();
      const ds=now.toLocaleDateString('en-US', {year:'numeric', month:'2-digit', day:'2-digit'});
      if(!ul.querySelector('li[data-key="hdr-cafe"]')){
        const li=document.createElement('li');
        li.setAttribute('data-key','hdr-cafe');
        li.textContent = `Added group-specific page header and cafeteria mode filter. (${ds})`;
        ul.prepend(li);
      }
    }

    /* ---------- Lightweight runtime tests ---------- */
    function runTests(){
      try{
        // schedule sizes (Mon-Thu) — each group has 17 blocks
        const mt1=scheduleMT('g1'); const mt2=scheduleMT('g2'); const mt3=scheduleMT('g3');
        console.assert(mt1.length===17, 'g1 MT length should be 17');
        console.assert(mt2.length===17, 'g2 MT length should be 17');
        console.assert(mt3.length===17, 'g3 MT length should be 17');
        // Friday count
        const fr=scheduleFri(); console.assert(fr.length===17, 'Friday length should be 17');
        // Cafeteria filter: no transitions & all overlap some lunch window (using MT windows)
        const wins=[...scheduleMT('g1'),...scheduleMT('g2'),...scheduleMT('g3')]
          .filter(b=>/Lunch/i.test(b.label))
          .map(b=>({start:b.start,end:b.end}));
        const cafG1 = filterByLunchWindows(scheduleMT('g1'), wins);
        console.assert(cafG1.every(b=>!/Transition/i.test(b.label)), 'Cafeteria filtered rows should exclude transitions');
        console.assert(cafG1.every(b=>overlapsLunch(b,wins)), 'Cafeteria filtered rows should overlap lunch windows');
        // current row builder sanity
        const now=new Date();
        const testBlock={label:'Test Period', start:new Date(now.getTime()-30000), end:new Date(now.getTime()+30000)};
        const tr=buildCurrentRow([testBlock],'g1',4);
        console.assert(tr.classList.contains('current-row'), 'Current row should have class current-row');
        // time parsing helpers
        const p1=parseInputTime('7:45 AM'); console.assert(p1 && p1.h===7 && p1.m===45, 'parse 7:45 AM');
        const p2=parseInputTime('12:00 AM'); console.assert(p2 && p2.h===0 && p2.m===0, 'parse 12:00 AM');
        const p3=parseInputTime('12:00 PM'); console.assert(p3 && p3.h===12 && p3.m===0, 'parse 12:00 PM');
        console.assert(timeToHHMM(fmt(7,5))==='07:05','HH:MM formatter');
        // invalid time parsing
        console.assert(parseInputTime('25:00')===null, 'invalid hour rejected');
        console.assert(parseInputTime('09:77')===null, 'invalid minute rejected');
        // overrides round-trip (non-destructive)
        const prev = loadOverrides();
        try {
          const tmp = { ...prev };
          tmp.MT = tmp.MT || {}; tmp.MT.gX = { 0: { label: 'X Block', start: '07:00', end: '07:30' } };
          localStorage.setItem(OV_KEY, JSON.stringify(tmp));
          const base=[makeBlock('Base','07:10','07:20')];
          const applied = applyOverrides(base.slice(), 'gX', 'MT');
          console.assert(applied[0].label==='X Block', 'override label applied');
          console.assert(applied[0].start.getHours()===7 && applied[0].start.getMinutes()===0, 'override start applied');
        } finally {
          localStorage.setItem(OV_KEY, JSON.stringify(prev));
        }
        // hide-past-breaks filter test
        const prevHB = hidePastBreaks; hidePastBreaks = true;
        try{
          const now2=new Date();
          const pastT={label:'Transition', start:new Date(now2.getTime()-600000), end:new Date(now2.getTime()-300000)};
          const futureT={label:'Transition', start:new Date(now2.getTime()+60000), end:new Date(now2.getTime()+120000)};
          const period={label:'1st Period', start:new Date(now2.getTime()-60000), end:new Date(now2.getTime()+600000)};
          const out=applyHidePastBreaks([pastT,futureT,period], now2);
          console.assert(!out.includes(pastT), 'past transition removed');
          console.assert(out.includes(futureT), 'future transition kept');
          console.assert(out.includes(period), 'period kept');
        } finally { hidePastBreaks = prevHB; }
        // enabled groups affect cafeteria windows
        const prevEG = localStorage.getItem('enabledGroups');
        try{
          setEnabledGroups({g1:true,g2:false,g3:false});
          const w = getLunchWindowsForToday();
          console.assert(w.length>0 && w.every(x=>x.group==='g1'), 'Lunch windows limited to enabled groups');
        } finally { if(prevEG){ localStorage.setItem('enabledGroups', prevEG); } else { localStorage.removeItem('enabledGroups'); } }
      }catch(e){ console.warn('Self-tests encountered an error:', e); }
    }

    /* ---------- Boot ---------- */
    (function init(){
      const savedName = localStorage.getItem('schoolName'); if(savedName) document.getElementById('school-name').textContent = savedName;
      loadColorCustom();
      displayDateTime(); setInterval(displayDateTime, 1000);
      updateSchedule(); setInterval(updateSchedule, 1000); appendWhatsNew();
      requestWakeLock();
      runTests();
    })();
  </script>

  <!-- Simple cookie check (kept) -->
  <script>
    function setCookie(name, value, days){ const d=new Date(); d.setTime(d.getTime()+days*24*60*60*1000); document.cookie = `${name}=${value}; expires=${d.toUTCString()}; path=/`; }
    function getCookie(name){ const nameEQ=name+"="; return document.cookie.split(';').map(c=>c.trim()).find(c=>c.indexOf(nameEQ)===0)?.substring(nameEQ.length)||null; }
    setCookie('test_cookie','active',7); if(getCookie('test_cookie')) console.log('Cookies OK');
  </script>
</body>
</html>
