<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MyClassBell</title>
<link rel="icon" href="MyAppIcon.png" type="image/png"/>

<style>
  :root{ --header-bg:#0b2e6f; --header-fg:#ffffff; --border:#eceff3; --bar-border:#cfd7e3; --accent:#007bff; }
  *{box-sizing:border-box} body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,Arial; margin:0; background:#fff; color:#111}

  /* Sticky header */
  #sticky-container{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--border)}
  #header-container{display:grid; grid-template-columns:.35fr 1fr .35fr; align-items:center; justify-items:center; gap:8px; padding:8px; background:var(--header-bg); color:var(--header-fg)}
  #school-name{cursor:pointer; font-size:1.2rem}
  #date,#time{font-size:1.05rem}

  /* Controls */
  #levelbar{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border); background:#fff; position:sticky; top:48px; z-index:1001; flex-wrap:wrap}
  .lvlbtn{background:#f4f4f4; border:1px solid var(--border); border-radius:6px; padding:6px 10px; cursor:pointer}
  .lvlbtn[aria-pressed="true"]{background:var(--accent); color:#fff}
  .view-title{flex:1 0 100%; background:#0B2E6F; color:#fff; text-align:center; padding:8px 10px; border-radius:8px; margin-top:6px}

  /* Tables */
  table{width:100%; border-collapse:collapse; table-layout:fixed; background:#fff}
  th,td{border:1px solid var(--border); padding:8px; text-align:center}
  #singleHeader thead th, #schedule thead th, #multiWrapper table thead th{background:#6B7280; color:#fff; font-weight:400}

  .current-row td{padding:0}
  .current-strip{height:40px; background:#f7f9fc; border:1px solid var(--bar-border); border-radius:8px; position:relative; overflow:hidden}
  .current-fill{position:absolute; inset:0 0 0 0; width:var(--fill,0%); background:linear-gradient(90deg, var(--c1,#e9f1ff), var(--c2,#f7fbff)); background-size:200% 100%; animation:stripWave 8s linear infinite; transition:width .5s ease}
  .current-label{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:500}

  tr.completed{opacity:.55; font-size:.9em}
  tr.upcoming td{background:#DAECFF}
  tr.lunch td{background:#FFF6D6; color:#0B6B2B; font-weight:800}
  tr.lunch.upcoming td{background:#B7E3C4; color:#0B6B2B}
  tr.upcoming td:first-child{box-shadow:inset 4px 0 0 #1b6ef3}

  /* Cards */
  #multiWrapper{display:none; gap:12px; margin:10px}
  .card{border:1px solid var(--border); border-radius:8px; overflow:hidden; background:#fff}
  .card-header{padding:8px 10px; text-align:center; font-weight:500; cursor:default}
  [data-group="g1"]>.card-header{background:#2F6ADF; color:#fff}
  [data-group="g2"]>.card-header{background:#1F8552; color:#fff}
  [data-group="g3"]>.card-header{background:#5A3DBF; color:#fff}

  /* Editable */
  td.editable{cursor:text}
  td[contenteditable="true"]{outline:2px solid #5bb98a; background:#f6fffa}
  #school-name[contenteditable="true"], .editable-header[contenteditable="true"]{outline:2px dashed #5bb98a; background:rgba(91,185,138,.12)}

  @keyframes stripWave{0%{background-position:0% 0}100%{background-position:200% 0}}

  /* Holiday banner */
  #holidayBanner{
    display:none; position:relative; justify-content:center; align-items:center; gap:10px;
    padding:12px 16px; text-align:center; color:#fff; font-weight:700;
    border-bottom:1px solid rgba(255,255,255,.15); animation:bannerSlide .5s ease-out 1;
  }
  #holidayBanner .inner{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:center}
  #holidayBanner .name{font-weight:800; text-shadow:0 1px 2px rgba(0,0,0,.25)}
  #holidayBanner .count{font-variant-numeric:tabular-nums; padding:2px 8px; border-radius:10px; background:rgba(255,255,255,.15)}
  #holidayBanner .tick{display:inline-block; min-width:1.7ch; animation:tickPulse 1s steps(1,end) infinite}
  #holidayBanner .badge{background:#ffcc00; color:#111; border-radius:6px; padding:2px 6px; font-weight:800; display:none}
  /* Dots layer */
  #holidayBanner .dots{pointer-events:none; position:absolute; inset:0; overflow:hidden}
  #holidayBanner .dot{position:absolute; width:6px; height:6px; border-radius:50%; opacity:.85; animation:floatDot var(--dur) linear infinite; filter:saturate(140%)}
  @keyframes bannerSlide{from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:translateY(0)}}
  @keyframes tickPulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  @keyframes floatDot{
    0%{transform:translateY(100%)} 
    100%{transform:translateY(-120%)}
  }

  /* Settings + Holiday modal (compact) */
  #settings-panel, #breaksModal{display:none}
  #settings-panel{position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; border:1px solid #ddd; padding:16px; z-index:2000; width:340px; box-shadow:0 8px 30px rgba(0,0,0,.15)}
  #settings-panel input, #settings-panel select{width:100%; padding:8px; margin:6px 0}
  #breaksModal{position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:2200; display:flex; align-items:center; justify-content:center}
  #breaksCard{width:min(560px,94vw); background:#fff; border-radius:12px; padding:16px; border:1px solid #e7ebf0; box-shadow:0 18px 50px rgba(0,0,0,.2)}
  #breaksCard h3{margin:0 0 8px}
  #breaksCard .row{display:flex; gap:10px; flex-wrap:wrap; margin:8px 0}
  #breaksCard label{font-size:.9rem; display:block}
  #breaksCard input[type="text"], #breaksCard input[type="datetime-local"], #breaksCard select{padding:8px; border:1px solid #d6dbe3; border-radius:6px; width:100%}
  #breaksCard .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}
  #breaksCard button{padding:8px 12px; border-radius:8px; border:1px solid #cfd7e3; background:#f7f9fc; cursor:pointer}
  #breaksCard button.primary{background:#0b6ef3; border-color:#0b6ef3; color:#fff}
</style>
</head>
<body>

<div id="sticky-container">
  <div id="header-container">
    <div id="date"><span id="day"></span> <span id="full-date"></span></div>
    <div id="school-name" title="Click to change header colors">Harmony Science Academy</div>
    <div id="time"></div>
  </div>

  <!-- Holiday banner (no 'Next Holiday' text) -->
  <div id="holidayBanner" role="status" aria-live="polite">
    <div class="dots" aria-hidden="true"></div>
    <div class="inner">
      <span class="prefix"></span>
      <span class="name"></span>
      <span class="count">
        <span class="days"><span class="tick">00</span>d</span>
        <span class="hours" style="margin-left:6px;"><span class="tick">00</span>h</span>
        <span class="mins" style="margin-left:6px;"><span class="tick">00</span>m</span>
        <span class="secs" style="margin-left:6px;"><span class="tick">00</span>s</span>
      </span>
      <span class="suffix"></span>
      <span class="badge">LAST DAY</span>
    </div>
  </div>

  <div id="levelbar">
    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap">
      <button class="lvlbtn" data-view="g1" title="L1 = 6th & 9th">L1</button>
      <button class="lvlbtn" data-view="g2" title="L2 = 7th & 10th">L2</button>
      <button class="lvlbtn" data-view="g3" title="L3 = 8th, 11th & 12th">L3</button>
      <button class="lvlbtn" data-view="all" title="Show all groups">All</button>
      <button id="cafBtn" class="lvlbtn" title="Show only lunch times">Enable Cafeteria</button>
    </div>
    <div style="display:flex; gap:6px; align-items:center; margin-left:auto">
      <button id="hideBreaksBtn" class="lvlbtn" title="Hide passed transitions">Hide Passed Breaks</button>
      <button id="holidayBtn" class="lvlbtn" title="Manage holiday banner">Banner / Holiday</button>
    </div>
    <div id="viewTitle" class="view-title"></div>
  </div>

  <table id="singleHeader"><thead><tr><th>Block</th><th>Start</th><th>End</th><th>Remaining</th></tr></thead></table>
</div>

<table id="schedule"><tbody></tbody></table>
<div id="multiWrapper"></div>

<!-- Settings -->
<div id="settings-panel">
  <h3>Settings</h3>
  <input id="school-name-input" placeholder="Enter school name"/>
  <label><strong>Default Grade Group</strong></label>
  <select id="group-select">
    <option value="g1">6th & 9th (L1)</option>
    <option value="g2">7th & 10th (L2)</option>
    <option value="g3">8th, 11th & 12th (L3)</option>
  </select>
  <div style="margin-top:8px">
    <label><strong>Visible Groups</strong></label>
    <div style="display:flex; gap:10px; margin-top:6px">
      <label><input type="checkbox" id="enabled-g1"> L1</label>
      <label><input type="checkbox" id="enabled-g2"> L2</label>
      <label><input type="checkbox" id="enabled-g3"> L3</label>
    </div>
  </div>
  <button onclick="saveSettings()">Save</button>
  <button onclick="closeSettings()">Close</button>
</div>
<button id="settings-button" style="position:fixed; bottom:20px; right:20px; padding:10px; background:#007bff; color:#fff; border:none; border-radius:50%; cursor:pointer" onclick="openSettings()">⚙</button>

<!-- Holiday Manager -->
<div id="breaksModal" aria-hidden="true">
  <div id="breaksCard" role="dialog" aria-modal="true" aria-labelledby="breaksTitle">
    <h3 id="breaksTitle">Holiday Banner & Countdown</h3>
    <div class="row">
      <div style="flex:1 1 260px">
        <label>Holiday name</label>
        <input id="brName" type="text" placeholder="e.g., Thanksgiving Break">
      </div>
      <div style="flex:1 1 220px">
        <label>Target date &amp; time</label>
        <input id="brWhen" type="datetime-local">
      </div>
    </div>

    <div class="row">
      <div style="flex:1 1 160px">
        <label>Text mode</label>
        <select id="bnTextMode">
          <option value="to">to [holiday]</option>
          <option value="remained">remained</option>
          <option value="none">no text</option>
        </select>
      </div>
      <div style="flex:1 1 160px">
        <label>Style</label>
        <select id="bnStyle">
          <option value="solid">Solid color</option>
          <option value="gradient">Two-color gradient</option>
          <option value="mix">Animated mix</option>
        </select>
      </div>
      <div style="flex:1 1 120px; display:flex; align-items:end">
        <label style="display:flex; gap:6px; align-items:center"><input id="bnDots" type="checkbox"> Moving dots</label>
      </div>
    </div>

    <div id="solidRow" class="row">
      <div style="flex:1 1 160px">
        <label>Solid color</label>
        <input id="bnSolid" type="color" value="#0b2e6f">
      </div>
    </div>
    <div id="gradRow" class="row" style="display:none">
      <div style="flex:1 1 160px">
        <label>Color A</label>
        <input id="bnGradA" type="color" value="#0b2e6f">
      </div>
      <div style="flex:1 1 160px">
        <label>Color B</label>
        <input id="bnGradB" type="color" value="#174ea6">
      </div>
    </div>

    <div class="row">
      <label><input id="brEnable" type="checkbox"> Show banner</label>
    </div>
    <div class="actions">
      <button id="brSave" class="primary">Save / Activate</button>
      <button id="brClear">Disable</button>
      <button id="brClose">Close</button>
    </div>

    <div style="margin-top:10px; border-top:1px dashed #e6e9f1; padding-top:8px">
      <strong>Saved holidays</strong>
      <div id="brList"></div>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
const OV_KEY='mb_overrides_v1';
function parseHM(dt){return dt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}).replace(/^0/,'');}
function fmt(h,m){const d=new Date(); d.setHours(h,m,0,0); return d;}
function parseInputTime(str){ if(!str) return null; const s=str.trim().toUpperCase(); const m=s.match(/^(\d{1,2}):(\d{2})(?:\s*(AM|PM))?$/); if(!m) return null; let h=+m[1], mi=+m[2]; if(m[3]==='AM'&&h===12) h=0; if(m[3]==='PM'&&h<12) h+=12; return {h, m:mi}; }
function parseTime(s){const [H,M]=s.split(':').map(Number); return [H,M];}
function makeBlock(label, a, b){const [sh,sm]=parseTime(a); const [eh,em]=parseTime(b); return {label,start:fmt(sh,sm),end:fmt(eh,em)};}
function timeToHHMM(d){return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');}
function loadOverrides(){try{return JSON.parse(localStorage.getItem(OV_KEY)||'{}')}catch(_){return{}}}
function saveOverrides(obj){localStorage.setItem(OV_KEY, JSON.stringify(obj))}
function saveOverride(dayKey, group, idx, patch){const o=loadOverrides(); if(!o[dayKey]) o[dayKey]={}; if(!o[dayKey][group]) o[dayKey][group]={}; const cur=o[dayKey][group][idx]||{}; o[dayKey][group][idx]={...cur,...patch}; saveOverrides(o)}
function applyOverrides(full, group, dayKey){const o=loadOverrides(); const map=(o[dayKey]&&o[dayKey][group])||{}; Object.keys(map).forEach(k=>{const i=+k; if(!full[i]) return; const p=map[k]; if(p.label) full[i].label=p.label; if(p.start){const [h,mm]=p.start.split(':').map(Number); full[i].start=fmt(h,mm)} if(p.end){const [h2,m2]=p.end.split(':').map(Number); full[i].end=fmt(h2,m2)}}); return full}
function isFriday(){return new Date().getDay()===5}
function getDayKey(){return isFriday()?'FRI':'MT'}

/* ---------- Schedules ---------- */
function scheduleMT(group){
  const S=[];
  S.push(makeBlock('Breakfast','07:15','07:40'));
  S.push(makeBlock('Transition','07:40','07:45'));
  S.push(makeBlock('1st Period','07:45','08:41'));
  S.push(makeBlock('Transition','08:41','08:46'));
  S.push(makeBlock('2nd Period','08:46','09:42'));
  S.push(makeBlock('Transition','09:42','09:47'));
  S.push(makeBlock('3rd Period','09:47','10:43'));
  S.push(makeBlock('Transition','10:43','10:48'));
  if(group==='g1'){
    S.push(makeBlock('L1 Lunch','10:48','11:23'));
    S.push(makeBlock('Transition','11:23','11:28'));
    S.push(makeBlock('5th Period','11:28','12:24'));
    S.push(makeBlock('Transition','12:24','12:29'));
    S.push(makeBlock('6th Period','12:29','13:25'));
    S.push(makeBlock('Transition','13:25','13:30'));
  }else if(group==='g2'){
    S.push(makeBlock('4th Period','10:48','11:44'));
    S.push(makeBlock('Transition','11:44','11:49'));
    S.push(makeBlock('L2 Lunch','11:49','12:24'));
    S.push(makeBlock('Transition','12:24','12:29'));
    S.push(makeBlock('6th Period','12:29','13:25'));
    S.push(makeBlock('Transition','13:25','13:30'));
  }else{
    S.push(makeBlock('4th Period','10:48','11:44'));
    S.push(makeBlock('Transition','11:44','11:49'));
    S.push(makeBlock('5th Period','11:49','12:45'));
    S.push(makeBlock('Transition','12:45','12:50'));
    S.push(makeBlock('L3 Lunch','12:50','13:25'));
    S.push(makeBlock('Transition','13:25','13:30'));
  }
  S.push(makeBlock('7th Period','13:30','14:26'));
  S.push(makeBlock('Transition','14:26','14:31'));
  S.push(makeBlock('8th Period','14:31','15:27'));
  return S;
}

/* Friday now depends on group: only that group’s lunch is shown */
function scheduleFri(group){
  const S=[];
  S.push(makeBlock('Breakfast','07:15','07:40'));
  S.push(makeBlock('Transition','07:40','07:45'));
  S.push(makeBlock('1st Period','07:45','08:21'));
  S.push(makeBlock('Transition','08:21','08:26'));
  S.push(makeBlock('2nd Period','08:26','09:02'));
  S.push(makeBlock('Transition','09:02','09:07'));
  S.push(makeBlock('3rd Period','09:07','09:43'));
  S.push(makeBlock('Transition','09:43','09:48'));
  S.push(makeBlock('4th Period','09:48','10:24'));
  S.push(makeBlock('Transition','10:24','10:29'));

  if(group==='g1'){                 // 6th & 9th
    S.push(makeBlock('L1 Lunch','10:29','11:05'));
    S.push(makeBlock('Transition','11:05','11:10'));
    S.push(makeBlock('6th Period','11:10','11:46'));
    S.push(makeBlock('Transition','11:46','11:51'));
    S.push(makeBlock('7th Period','11:51','12:27'));
  }else if(group==='g2'){           // 7th & 10th
    S.push(makeBlock('5th Period','10:29','11:05'));
    S.push(makeBlock('Transition','11:05','11:10'));
    S.push(makeBlock('L2 Lunch','11:10','11:46'));
    S.push(makeBlock('Transition','11:46','11:51'));
    S.push(makeBlock('7th Period','11:51','12:27'));
  }else{                            // g3: 8th, 11th, 12th
    S.push(makeBlock('5th Period','10:29','11:05'));
    S.push(makeBlock('Transition','11:05','11:10'));
    S.push(makeBlock('6th Period','11:10','11:46'));
    S.push(makeBlock('Transition','11:46','11:51'));
    S.push(makeBlock('L3 Lunch','11:51','12:27'));
  }
  S.push(makeBlock('Transition','12:27','12:32'));
  S.push(makeBlock('8th Period','12:32','13:08'));
  return S;
}

function getTodaySchedule(group){ return isFriday()?scheduleFri(group):scheduleMT(group); }

/* ---------- Titles ---------- */
const TITLES_KEY='group_titles_v1';
const DEFAULT_TITLES={g1:'6th Grade & Freshman', g2:'7th Grade & Sophomore', g3:'8th Grade, Junior & Senior'};
function loadGroupTitles(){try{const s=JSON.parse(localStorage.getItem(TITLES_KEY)||'{}'); return {...DEFAULT_TITLES,...s}}catch(_){return {...DEFAULT_TITLES}}}
function saveGroupTitle(g,t){const cur=loadGroupTitles(); cur[g]=(t&&t.trim())?t.trim():DEFAULT_TITLES[g]; localStorage.setItem(TITLES_KEY, JSON.stringify(cur))}
let GROUP_TITLES=loadGroupTitles();

/* ---------- App state ---------- */
let currentGroup=localStorage.getItem('gradeGroup')||'g1';
let selectedView=localStorage.getItem('selectedView')||currentGroup;
let cafOnly=(localStorage.getItem('cafOnly')==='1');
let hidePastBreaks=(localStorage.getItem('hidePastBreaks')==='1');
let isEditing=false, editTimeout=null;

function getEnabledGroups(){
  let obj; try{obj=JSON.parse(localStorage.getItem('enabledGroups')||'{}')}catch(_){obj={}}
  const d={g1:true,g2:true,g3:true}; obj={...d,...obj};
  const list=Object.keys(d).filter(k=>!!obj[k]); return list.length?list:['g1'];
}
function setEnabledGroups(o){localStorage.setItem('enabledGroups', JSON.stringify(o))}
function isGroupEnabled(id){return getEnabledGroups().includes(id)}

/* ---------- Lunch filters (for cafeteria mode) ---------- */
function getLunchWindowsForToday(groups){
  const gs=Array.isArray(groups)?groups:getEnabledGroups();
  const wins=[]; const dayKey=getDayKey();
  gs.forEach(g=>{
    let sched=getTodaySchedule(g); sched=applyOverrides(sched,g,dayKey);
    sched.forEach(b=>{if(/Lunch/i.test(b.label)) wins.push({start:b.start, end:b.end})})
  });
  return wins;
}
function overlapsLunch(block,windows){return windows.some(w=> block.start<w.end && block.end>w.start)}
function filterByLunchWindows(arr,windows){return arr.filter(b=> !/^Transition$/i.test(b.label) && overlapsLunch(b,windows))}
function applyHidePastBreaks(arr){const now=new Date(); return hidePastBreaks?arr.filter(b=>!( /^Transition$/i.test(b.label) && b.end<now )):arr}

/* ---------- Current strip ---------- */
function getStripPalette(group,label){
  if(/Transition/i.test(label)) return ['#ff2d2d','#ff6b6b'];
  if(/Lunch/i.test(label)) return ['#0f5a2e','#1d8b4d'];
  if(group==='g1') return ['#bcd4ff','#d5e6ff'];
  if(group==='g2') return ['#cdeed8','#e2f6e8'];
  return ['#cec3ff','#e2d9ff'];
}
function findCurrent(full){const now=new Date(); for(let i=0;i<full.length;i++){const b=full[i]; if(now>=b.start && now<b.end) return {idx:i,b};} return null}
function buildCurrentRow(full, group, colCount){
  const row=document.createElement('tr'); row.className='current-row';
  const td=document.createElement('td'); td.colSpan=colCount;
  const strip=document.createElement('div'); strip.className='current-strip';
  const fill=document.createElement('div'); fill.className='current-fill';
  const label=document.createElement('div'); label.className='current-label';
  const now=new Date(); const cur=findCurrent(full);
  if(cur){
    const total=cur.b.end-cur.b.start, elapsed=now-cur.b.start, pct=Math.max(0,Math.min(1,elapsed/total))*100;
    const rem=cur.b.end-now; const m=Math.floor(rem/60000), s=Math.floor((rem%60000)/1000); const showSec=rem<=180000;
    fill.style.setProperty('--fill', pct+'%'); const pal=getStripPalette(group,cur.b.label); fill.style.setProperty('--c1',pal[0]); fill.style.setProperty('--c2',pal[1]);
    label.textContent=`${cur.b.label} — ${showSec?`${m}:${String(s).padStart(2,'0')}`:`${m} min`} left`;
  }else{
    const next=full.find(b=>now<b.start); const pal=getStripPalette(group,''); fill.style.setProperty('--c1',pal[0]); fill.style.setProperty('--c2',pal[1]);
    label.textContent=next?`Next: ${next.label} at ${parseHM(next.start)}`:'Schedule complete';
  }
  strip.appendChild(fill); strip.appendChild(label); td.appendChild(strip); row.appendChild(td); return row;
}
function renderRows(blocks, tbody, full, gid){
  const now=new Date();
  blocks.forEach(b=>{
    const isLunch=/Lunch/i.test(b.label), isOngoing=now>=b.start&&now<b.end, isCompleted=now>=b.end;
    const remaining=Math.max(0,b.end-now), sec=Math.floor(remaining/1000); const rMin=Math.floor(sec/60), rSec=sec%60; const showSec=remaining<=180000;
    const tr=document.createElement('tr'); tr.classList.add('data-row'); tr.dataset.index=String(full.indexOf(b)); tr.dataset.group=gid||'';
    if(isLunch) tr.classList.add('lunch'); if(isOngoing) tr.classList.add('upcoming'); if(isCompleted) tr.classList.add('completed');
    tr.innerHTML=`<td class="editable">${b.label}</td><td class="editable">${parseHM(b.start)}</td><td class="editable">${parseHM(b.end)}</td><td>${isOngoing?(showSec?`${rMin} min ${String(rSec).padStart(2,'0')} sec`:`${rMin} min`): (isCompleted?'Completed':'Upcoming')}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- Render ---------- */
function updateSchedule(){
  if(isEditing) return;
  const singleHeader=document.getElementById('singleHeader'), table=document.getElementById('schedule'), multi=document.getElementById('multiWrapper'), vt=document.getElementById('viewTitle');
  GROUP_TITLES=loadGroupTitles();
  const enabled=getEnabledGroups();
  if(['g1','g2','g3'].includes(selectedView) && !enabled.includes(selectedView)){selectedView=enabled[0]||'all'; localStorage.setItem('selectedView',selectedView)}
  if(['g1','g2','g3'].includes(currentGroup) && !enabled.includes(currentGroup)){currentGroup=enabled[0]||'g1'; localStorage.setItem('gradeGroup',currentGroup)}

  if(selectedView==='g1'){vt.textContent=GROUP_TITLES.g1+' Bell Schedule'; vt.style.display='block'}
  else if(selectedView==='g2'){vt.textContent=GROUP_TITLES.g2+' Bell Schedule'; vt.style.display='block'}
  else if(selectedView==='g3'){vt.textContent=GROUP_TITLES.g3+' Bell Schedule'; vt.style.display='block'}
  else{vt.textContent=''; vt.style.display='none'}

  document.querySelectorAll('.lvlbtn[data-view]').forEach(b=>{
    const id=b.getAttribute('data-view');
    if(['g1','g2','g3'].includes(id)){ b.style.display=enabled.includes(id)?'':'none'; b.setAttribute('aria-pressed', id===selectedView); }
    else if(id==='all'){ b.style.display=enabled.length?'':'none'; b.setAttribute('aria-pressed', selectedView==='all'); }
  });
  const cafBtn=document.getElementById('cafBtn'); cafBtn.setAttribute('aria-pressed', cafOnly); cafBtn.textContent=cafOnly?'Disable Cafeteria':'Enable Cafeteria';
  const hbBtn=document.getElementById('hideBreaksBtn'); hbBtn.setAttribute('aria-pressed', hidePastBreaks); hbBtn.textContent=hidePastBreaks?'Show Passed Breaks':'Hide Passed Breaks';

  const lunchWindows=cafOnly?getLunchWindowsForToday(enabled):null;
  const filterBlocks=(arr)=>cafOnly?filterByLunchWindows(arr,lunchWindows):arr;

  if(selectedView==='all'){
    singleHeader.style.display='none'; table.style.display='none'; multi.style.display='grid'; multi.style.gridTemplateColumns='repeat(3, minmax(260px,1fr))'; multi.innerHTML='';
    getEnabledGroups().forEach(id=>{
      const card=document.createElement('div'); card.className='card'; card.setAttribute('data-group',id);
      const hdr=document.createElement('div'); hdr.className='card-header'; hdr.textContent=GROUP_TITLES[id];
      const tbl=document.createElement('table'); tbl.innerHTML=`<thead><tr><th>Block</th><th>Start</th><th>End</th><th>Remaining</th></tr></thead>`;
      const tb=document.createElement('tbody'); let full=getTodaySchedule(id); full=applyOverrides(full,id,getDayKey());
      tb.appendChild(buildCurrentRow(full,id,4));
      const visible=applyHidePastBreaks(filterBlocks(full)); renderRows(visible,tb,full,id);
      tbl.appendChild(tb); card.appendChild(hdr); card.appendChild(tbl); multi.appendChild(card);
    });
  }else{
    singleHeader.style.display='table'; table.style.display='table'; multi.style.display='none';
    const tbody=table.querySelector('tbody'); tbody.innerHTML='';
    let full=getTodaySchedule(selectedView); full=applyOverrides(full,selectedView,getDayKey());
    tbody.appendChild(buildCurrentRow(full,selectedView,4));
    const visible=applyHidePastBreaks(filterBlocks(full)); renderRows(visible,tbody,full,selectedView);
  }
}

/* ---------- Interactions ---------- */
document.addEventListener('click', (e)=>{
  const btn=e.target.closest('.lvlbtn'); if(!btn) return;
  if(btn.id==='cafBtn'){cafOnly=!cafOnly; localStorage.setItem('cafOnly',cafOnly?'1':'0'); updateSchedule(); return;}
  if(btn.id==='hideBreaksBtn'){hidePastBreaks=!hidePastBreaks; localStorage.setItem('hidePastBreaks',hidePastBreaks?'1':'0'); updateSchedule(); return;}
  if(btn.dataset.view){const id=btn.dataset.view; if(['g1','g2','g3'].includes(id)&&!isGroupEnabled(id)) return; selectedView=id; localStorage.setItem('selectedView',id); if(id!=='all') {currentGroup=id; localStorage.setItem('gradeGroup',id);} updateSchedule();}
});
function selectAll(el){const r=document.createRange(); r.selectNodeContents(el); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);}
function commitCellEdit(td){
  const tr=td.closest('tr'); if(!tr) return; const idx=+tr.dataset.index; const gid=tr.dataset.group || (selectedView==='all'?'g1':selectedView); const dayKey=getDayKey();
  let full=applyOverrides(getTodaySchedule(gid),gid,dayKey); const blk=full[idx]; if(!blk) return;
  const col=td.cellIndex; const raw=td.textContent.trim();
  if(col===0){ if(raw) saveOverride(dayKey,gid,idx,{label:raw}); }
  else if(col===1||col===2){
    const t=parseInputTime(raw); if(!t){ alert('Use H:MM or H:MM AM/PM'); td.textContent=(col===1?parseHM(blk.start):parseHM(blk.end)); return; }
    const newD=fmt(t.h,t.m); if(col===1 && newD>=blk.end){ alert('Start must be before end.'); td.textContent=parseHM(blk.start); return; }
    if(col===2 && newD<=blk.start){ alert('End must be after start.'); td.textContent=parseHM(blk.end); return; }
    const patch={}; patch[col===1?'start':'end']=timeToHHMM(newD); saveOverride(dayKey,gid,idx,patch);
  }
  isEditing=false; td.removeAttribute('contenteditable'); updateSchedule();
}
function beginHeaderEdit(el, gid){
  if(!gid) return; isEditing=true; el.classList.add('editable-header'); el.setAttribute('contenteditable','true'); selectAll(el); el.focus();
  const finish=(commit)=>{el.removeEventListener('blur',onB); el.removeEventListener('keydown',onK); const t=el.textContent.replace(/Bell Schedule$/,'').trim(); el.removeAttribute('contenteditable'); el.classList.remove('editable-header'); if(commit&&t) saveGroupTitle(gid,t); isEditing=false; updateSchedule();};
  const onB=()=>finish(true); const onK=(e)=>{if(e.key==='Enter'){e.preventDefault(); finish(true)} if(e.key==='Escape'){e.preventDefault(); finish(false)}};
  el.addEventListener('blur',onB,{once:true}); el.addEventListener('keydown',onK);
}
document.addEventListener('dblclick', (e)=>{
  if(e.target.closest('#school-name')){
    const sn=document.getElementById('school-name'); isEditing=true; sn.setAttribute('contenteditable','true'); sn.focus(); selectAll(sn);
    const onBlur=()=>{const v=sn.textContent.trim(); if(v){localStorage.setItem('schoolName',v)} sn.removeAttribute('contenteditable'); isEditing=false; sn.removeEventListener('blur',onBlur);}; sn.addEventListener('blur',onBlur,{once:true}); return;
  }
  const vt=e.target.closest('#viewTitle'); if(vt && ['g1','g2','g3'].includes(selectedView)){ vt.textContent=loadGroupTitles()[selectedView]; beginHeaderEdit(vt,selectedView); return;}
  const hdr=e.target.closest('.card-header'); if(hdr){ const gid=hdr.parentElement?.getAttribute('data-group'); if(['g1','g2','g3'].includes(gid)) beginHeaderEdit(hdr,gid); return; }
  const td=e.target.closest('td.editable'); if(!td) return; const tr=td.closest('tr'); if(!tr||!tr.classList.contains('data-row')) return;
  isEditing=true; td.setAttribute('contenteditable','true'); td.focus(); selectAll(td); clearTimeout(editTimeout); editTimeout=setTimeout(()=>{ if(td.isContentEditable) commitCellEdit(td); }, 5*60*1000);
});
document.addEventListener('keydown',(e)=>{const ed=e.target.closest('td[contenteditable="true"], #school-name[contenteditable="true"], .editable-header[contenteditable="true"]'); if(!ed) return; if(e.key==='Enter'){e.preventDefault(); ed.blur();} if(e.key==='Escape'){e.preventDefault(); isEditing=false; ed.removeAttribute('contenteditable'); updateSchedule();}});
document.addEventListener('blur',(e)=>{const td=e.target.closest('td[contenteditable="true"]'); if(!td) return; commitCellEdit(td);}, true);

/* ---------- Date/time ---------- */
function displayDateTime(){const now=new Date(); document.getElementById('day').textContent=now.toLocaleDateString('en-US',{weekday:'long'}); document.getElementById('full-date').textContent=now.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}); document.getElementById('time').textContent=now.toLocaleTimeString('en-US',{hour:'numeric',minute:'numeric',second:'numeric'})}

/* ---------- Settings ---------- */
function openSettings(){document.getElementById('school-name-input').value=localStorage.getItem('schoolName')||''; document.getElementById('group-select').value=currentGroup; const en=getEnabledGroups(); ['g1','g2','g3'].forEach(id=>document.getElementById('enabled-'+id).checked=en.includes(id)); document.getElementById('settings-panel').style.display='block'}
function closeSettings(){document.getElementById('settings-panel').style.display='none'}
function saveSettings(){
  const name=document.getElementById('school-name-input').value.trim(); if(name){localStorage.setItem('schoolName',name); document.getElementById('school-name').textContent=name}
  currentGroup=document.getElementById('group-select').value; localStorage.setItem('gradeGroup',currentGroup);
  const eg={g1:!!document.getElementById('enabled-g1').checked,g2:!!document.getElementById('enabled-g2').checked,g3:!!document.getElementById('enabled-g3').checked}; if(!eg.g1&&!eg.g2&&!eg.g3) eg.g1=true; setEnabledGroups(eg);
  const enabled=getEnabledGroups(); if(selectedView!=='all' && !enabled.includes(selectedView)){selectedView=enabled[0]||'all'; localStorage.setItem('selectedView',selectedView)} if(currentGroup && !enabled.includes(currentGroup)){currentGroup=enabled[0]||'g1'; localStorage.setItem('gradeGroup',currentGroup)}
  closeSettings(); updateSchedule();
}

/* ---------- Banner/holiday storage ---------- */
const BR_STORE='mcb_breaks_v1', BR_ACTIVE='mcb_break_active_id', BR_ENABLED='mcb_break_enabled';
const BN_OPTS='mcb_banner_opts_v1'; // {style:'solid'|'gradient'|'mix', text:'to'|'remained'|'none', dots:true, solid:'#hex', gradA:'#', gradB:'#'}
function readBreaks(){try{return JSON.parse(localStorage.getItem(BR_STORE)||'[]')}catch(_){return[]}}
function writeBreaks(x){localStorage.setItem(BR_STORE, JSON.stringify(x))}
function setActiveBreak(id){localStorage.setItem(BR_ACTIVE, id||'')}
function getActiveBreakId(){return localStorage.getItem(BR_ACTIVE)||''}
function setBreakEnabled(on){localStorage.setItem(BR_ENABLED, on?'1':'0')}
function isBreakEnabled(){return localStorage.getItem(BR_ENABLED)==='1'}
function readBannerOpts(){try{return JSON.parse(localStorage.getItem(BN_OPTS)||'{}')}catch(_){return{}}}
function writeBannerOpts(o){localStorage.setItem(BN_OPTS, JSON.stringify(o))}

/* ---------- Banner rendering ---------- */
let brTimer=null;
function fmt2(n){return n.toString().padStart(2,'0')}
function ensureDots(container){
  if(container.children.length) return;
  const colors=['#ff4757','#ffa502','#2ed573','#1e90ff','#a55eea','#ff6b81','#2ecc71','#eccc68'];
  for(let i=0;i<18;i++){
    const s=document.createElement('span'); s.className='dot';
    const left=Math.random()*100, delay=Math.random()*6, dur=6+Math.random()*8, size=4+Math.random()*6;
    s.style.left=left+'%'; s.style.bottom='-10px'; s.style.animationDelay=`-${delay}s`; s.style.setProperty('--dur', dur+'s');
    s.style.width=size+'px'; s.style.height=size+'px'; s.style.background=colors[i%colors.length];
    container.appendChild(s);
  }
}
function applyBannerStyle(banner, opts){
  if(opts.style==='gradient'){
    const a=opts.gradA||'#0b2e6f', b=opts.gradB||'#174ea6';
    banner.style.background=`linear-gradient(90deg, ${a}, ${b})`;
    banner.style.backgroundSize='200% 100%';
    banner.style.animation='bannerSlide .5s ease-out 1, stripWave 14s linear infinite';
  }else if(opts.style==='mix'){
    banner.style.background='linear-gradient(135deg, #b3004b, #006241, #d62400, #b3004b)';
    banner.style.backgroundSize='300% 300%';
    banner.style.animation='bannerSlide .5s ease-out 1, stripWave 12s linear infinite';
  }else{
    banner.style.background=opts.solid||'#0b2e6f';
    banner.style.animation='bannerSlide .5s ease-out 1';
  }
}
function renderHolidayBanner(){
  const banner=document.getElementById('holidayBanner');
  const nameEl=banner.querySelector('.name'); const daysEl=banner.querySelector('.days .tick'); const hoursEl=banner.querySelector('.hours .tick'); const minsEl=banner.querySelector('.mins .tick'); const secsEl=banner.querySelector('.secs .tick'); const badge=banner.querySelector('.badge'); const prefix=banner.querySelector('.prefix'); const suffix=banner.querySelector('.suffix'); const dots=banner.querySelector('.dots');

  const enabled=isBreakEnabled(); const activeId=getActiveBreakId(); const list=readBreaks(); const br=list.find(b=>b.id===activeId);
  if(!enabled||!br){ banner.style.display='none'; return; }
  banner.style.display='flex';

  const opts={style:'solid',text:'to',dots:false,solid:'#0b2e6f',gradA:'#0b2e6f',gradB:'#174ea6', ...readBannerOpts()};
  applyBannerStyle(banner, opts);
  if(opts.dots){ ensureDots(dots); dots.style.display='block'; } else { dots.style.display='none'; }

  // text mode
  prefix.textContent = (opts.text==='to') ? 'to' : '';
  suffix.textContent = (opts.text==='remained') ? 'remained' : '';

  nameEl.textContent = br.name||'Holiday';
  const now=new Date(); const target=new Date(br.when); const diff=target-now;
  if(diff<=0){ daysEl.textContent='00'; hoursEl.textContent='00'; minsEl.textContent='00'; secsEl.textContent='00'; badge.style.display='none'; return; }
  const totalSec=Math.floor(diff/1000); const d=Math.floor(totalSec/86400); const rem=totalSec%86400; const h=Math.floor(rem/3600); const m=Math.floor((rem%3600)/60); const s=rem%60;
  daysEl.textContent=fmt2(d); hoursEl.textContent=fmt2(h); minsEl.textContent=fmt2(m); secsEl.textContent=fmt2(s);
  badge.style.display = (d===0) ? 'inline-block' : 'none';

  // if no text mode, hide prefix/name/suffix spacing
  if(opts.text==='none'){ prefix.textContent=''; suffix.textContent=''; }
}
function startHolidayTicker(){ if(brTimer) clearInterval(brTimer); brTimer=setInterval(renderHolidayBanner,1000); renderHolidayBanner(); }

/* ---------- Holiday modal ---------- */
function openBreaksModal(){ document.getElementById('breaksModal').style.display='flex'; document.getElementById('breaksModal').setAttribute('aria-hidden','false'); populateBreaksUI(); }
function closeBreaksModal(){ document.getElementById('breaksModal').style.display='none'; document.getElementById('breaksModal').setAttribute('aria-hidden','true'); }
function populateBreaksUI(){
  const list=readBreaks(); const act=getActiveBreakId(); const br=list.find(b=>b.id===act);
  document.getElementById('brName').value=br?.name||''; document.getElementById('brWhen').value=br?toLocalInput(br.when):''; document.getElementById('brEnable').checked=isBreakEnabled();

  const opts={style:'solid',text:'to',dots:false,solid:'#0b2e6f',gradA:'#0b2e6f',gradB:'#174ea6', ...readBannerOpts()};
  document.getElementById('bnTextMode').value=opts.text; document.getElementById('bnStyle').value=opts.style; document.getElementById('bnDots').checked=!!opts.dots;
  document.getElementById('bnSolid').value=opts.solid; document.getElementById('bnGradA').value=opts.gradA; document.getElementById('bnGradB').value=opts.gradB;
  toggleStyleRows();

  const wrap=document.getElementById('brList'); wrap.innerHTML='';
  list.sort((a,b)=> new Date(a.when)-new Date(b.when)).forEach(item=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0'; row.style.gap='8px';
    const left=document.createElement('span'); left.innerHTML=`<strong>${item.name||'Unnamed'}</strong> <span style="opacity:.7">(${new Date(item.when).toLocaleString()})</span>`;
    const right=document.createElement('span');
    const use=document.createElement('button'); use.textContent=item.id===act?'Active':'Use'; use.className=item.id===act?'primary':''; use.onclick=()=>{setActiveBreak(item.id); populateBreaksUI(); renderHolidayBanner();}
    const del=document.createElement('button'); del.textContent='Delete'; del.onclick=()=>{writeBreaks(readBreaks().filter(x=>x.id!==item.id)); if(getActiveBreakId()===item.id) setActiveBreak(''); populateBreaksUI(); renderHolidayBanner();}
    right.appendChild(use); right.appendChild(del); row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
  });
}
function toggleStyleRows(){
  const st=document.getElementById('bnStyle').value;
  document.getElementById('solidRow').style.display = (st==='solid')?'flex':'none';
  document.getElementById('gradRow').style.display  = (st==='gradient')?'flex':'none';
}
document.getElementById('bnStyle').addEventListener('change', toggleStyleRows);

function toLocalInput(iso){const d=new Date(iso); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${y}-${m}-${day}T${hh}:${mm}`}

function saveActiveBreakFromUI(){
  const name=document.getElementById('brName').value.trim();
  const whenVal=document.getElementById('brWhen').value;
  const enabled=!!document.getElementById('brEnable').checked;
  if(!whenVal){alert('Please select a date & time.'); return;}
  const when=new Date(whenVal); if(Number.isNaN(when.getTime())){alert('Invalid date & time.'); return;}
  let list=readBreaks(); let act=getActiveBreakId(); let br=list.find(b=>b.id===act);
  if(!br){ br={id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())), name, when:when.toISOString()}; list.push(br); setActiveBreak(br.id); }
  else{ br.name=name||br.name; br.when=when.toISOString(); }
  writeBreaks(list); setBreakEnabled(enabled);

  // save banner opts
  const opts={
    style: document.getElementById('bnStyle').value,
    text:  document.getElementById('bnTextMode').value,
    dots:  !!document.getElementById('bnDots').checked,
    solid: document.getElementById('bnSolid').value,
    gradA: document.getElementById('bnGradA').value,
    gradB: document.getElementById('bnGradB').value
  };
  writeBannerOpts(opts);

  renderHolidayBanner(); startHolidayTicker(); populateBreaksUI();
}
document.getElementById('holidayBtn').addEventListener('click', openBreaksModal);
document.getElementById('brClose').addEventListener('click', closeBreaksModal);
document.getElementById('brSave').addEventListener('click', saveActiveBreakFromUI);
document.getElementById('brClear').addEventListener('click', ()=>{ setBreakEnabled(false); renderHolidayBanner(); closeBreaksModal(); });
document.getElementById('breaksModal').addEventListener('click', (e)=>{ if(e.target.id==='breaksModal') closeBreaksModal(); });

/* ---------- Header color custom via name click ---------- */
document.getElementById('school-name').addEventListener('click', ()=>{
  const bg=prompt('Header background hex (e.g. #0b2e6f):', localStorage.getItem('headerBgColor')||'#0b2e6f');
  const fg=prompt('Header text hex (e.g. #ffffff):', localStorage.getItem('textColor')||'#ffffff');
  if(bg){document.getElementById('header-container').style.backgroundColor=bg; localStorage.setItem('headerBgColor',bg);}
  if(fg){['school-name','date','time'].forEach(id=>document.getElementById(id).style.color=fg); localStorage.setItem('textColor',fg);}
});
function loadHeaderColors(){
  const bg=localStorage.getItem('headerBgColor')||'#0b2e6f', fg=localStorage.getItem('textColor')||'#ffffff';
  document.getElementById('header-container').style.backgroundColor=bg; ['school-name','date','time'].forEach(id=>document.getElementById(id).style.color=fg);
}

/* ---------- Boot ---------- */
(function init(){
  const saved=localStorage.getItem('schoolName'); if(saved) document.getElementById('school-name').textContent=saved;
  loadHeaderColors();
  displayDateTime(); setInterval(displayDateTime,1000);
  updateSchedule(); setInterval(()=>{ if(!isEditing) updateSchedule(); },1000);
  startHolidayTicker();
})();
</script>
</body>
</html>
